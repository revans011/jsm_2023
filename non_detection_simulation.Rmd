---
title: "R Notebook"
output: pdf_document
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{amsthm}
  - \usepackage{amsmath}
  - \usepackage{amsfonts}
  - \usepackage{amscd}
  - \usepackage{amssymb}
---

```{r echo=FALSE}
#install.packages("pacman")
pacman::p_load(
rio,        # to import data
       data.table, # to group and clean data
       tidyverse,  # allows use of pipe (%>%) function in this chapter
       here,       #path for importing 
       janitor,     #for clean_names and tabyl
       broom,   #tidy output, use tidy(xxx)
       gtsummary,  #nice tables
       magrittr, # for %<>%
       skimr, #for data summaries
       ggplot2, #for plotting
        hrbrthemes, #themes fore ggplot2
        kableExtra,
        caret
   ) 

options(digits = 4)
```

```{r}


predisposition.naive <- c(runif(200,min=0.55,max=1)
                    ,runif(100,min=0.45,max=0.55)
                    ,runif(200,min=0,max=0.45))

# the number to change from low disposition to high
proportion.detection.error<-0.05 #1-SE
trim.predisp<-round(length(predisposition.naive)*
                      proportion.detection.error)


predisposition <- head(predisposition.naive,-trim.predisp)
predisposition <- c(predisposition,runif(trim.predisp,min=0.55,max=1))

df<-data.frame(predisposition.naive = predisposition.naive
               ,predisposition = predisposition
               ,observed_rupture=c(rep(1,200)
                     ,sample(c(0,1), replace=TRUE, size=100)
                     ,rep(0,200)))
```



```{r}

fisher.b<-NULL
coef.pvalues<-NULL

for(i in 1:300){

predisposition=rbeta(500,2,2)  #upsidedown U
#predisposition=rbeta(500,.5,.5) #u shape
#predisposition=rbeta(500,1,1) #uniform

naive.rupture<-rbinom(length(predisposition),size=1,predisposition)

observed.rupture<-naive.rupture

observed.rupture[sample(which(naive.rupture==1)
                                       ,100)]<-0

df<-data.frame(predisposition=predisposition
               ,naive.rupture=naive.rupture
               ,observed.rupture=observed.rupture)

m.naive<- glm(naive.rupture ~ predisposition, family="binomial",data=df)
#summary(m.naive)
#print(coef(summary(m.naive))[,4])

m2<- glm(observed.rupture ~ predisposition, family="binomial",data=df)
#summary(m2)

#print("diff in coeff, closer to 1 is more different")
#print((m.naive$coefficients - m2$coefficients)/abs(m.naive$coefficients))

fisher.b<-c(fisher.b,(coef(summary(m2))[,1] - coef(summary(m.naive))[,1])/abs(coef(summary(m.naive))[,1]))

coef.pvalues<-c(coef.pvalues,coef(summary(m.naive))[,4],coef(summary(m2))[,4])

  }

foo<-data.frame(fisher.b=t(matrix(fisher.b,nrow=2))
           ,pvalues=t(matrix(coef.pvalues,nrow=4))) %>% 
  rename(fisher.b.intercept=fisher.b.1
         ,fisher.b.coef=fisher.b.2
         ,naive.p.intercept=pvalues.1
         ,naive.p.coef=pvalues.2
         ,observed.m.p.intercept=pvalues.3
         ,observed.m.p.coef=pvalues.4) %>% 
  mutate(naive.signif=ifelse(naive.p.coef>0.05,0,1)) %>% 
  mutate(observed.m.signif=ifelse(observed.m.p.coef>0.05,0,1)) %>% 
  mutate(diff.inference=ifelse(observed.m.signif==naive.signif,0,1))


```


```{r}
tbl_summary(foo)
```


```{r}
hist(predisposition)
```


```{r}
ggplot(df, aes(x=predisposition, y=naive.rupture)) + geom_point() +
      stat_smooth(method="glm", color="green", se=FALSE,
                method.args = list(family=binomial))
```

