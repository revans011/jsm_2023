---
title: "sim"
author: Report by Rich Evans
date: 2023
output:
    html_document


---

This simulation implements part of:

Gu W, Swihart RK. Absent or undetected? Effects of non-detection of species occurrence on wildlifeâ€“habitat models. Biological conservation. 2004 Apr 1;116(2):195-203.

But they are random sampling a wildlife area. They randomly pick occupied areas in the simulation. In other words they have a grid and randomly assign the occupied areas. 

I have retrospective data there. I use a mixture of normals because I have sample sizes I need to investigate

```{r,include=FALSE}
# install.packages("pacman")
pacman::p_load(
    data.table, # to group and clean data
    tidyverse, # allows use of pipe (%>%) function in this chapter
    janitor, # for clean_names and tabyl
    broom, # tidy output, use tidy(xxx)
    gtsummary, # nice tables
    magrittr, # for %<>%
    effectsize,
    pROC,
    rstatix,
    pwr, # power calculations
    pander, # to write tables as simple text for cut-and-paste
    knitr,
    rcompanion, # for cohen's w
    kableExtra,
    bindata,
    here
)

here::i_am("README.md")
```




```{r,include=FALSE}
sim.fun <- function(
    num.iter = NULL,
    n.cases = NULL,
    n.naiv.control = NULL,
    eff.sz = NULL,
    prp.nondet = NULL, ...) {
    out1 <- NULL
    out2 <- NULL
    out3 <- NULL
    out4 <- NULL

    ### numbers of things
    n.dogs <- n.cases + n.naiv.control # total number of dogs


    # control group is made up of the unlabeled pos and the real unaffected
    # number of positive dogs who are unlabled
    unlab.pos <- round(n.naiv.control * prp.nondet)
    n.tru.unaff <- n.naiv.control - unlab.pos # the number of unaffected

    n.tru.aff <- n.cases + unlab.pos # the number of positive dogs in both groups

    tru.labels <- c(rep(1, n.tru.aff), rep(0, (n.dogs - n.tru.aff)))
    naive.labels <- c(rep(1, n.cases), rep(0, n.naiv.control))



    for (i in 1:num.iter) {
        ### sample X
        # this is where the stocastic part comes in

        x.tru.affected <- rnorm(n.cases, mean = eff.sz)

        x.tru.control <- c(
            rnorm(unlab.pos, mean = eff.sz),
            rnorm(n.tru.unaff)
        )

        naive_X <- c(x.tru.affected, x.tru.control)
        naive_X_z <- (naive_X - mean(naive_X)) / sd(naive_X)

        # naive.dat <- data.frame(
        #     X = as.numeric(pnorm(naive_X_z) > runif(200, min = -.1, max = .1)),
        #     y = naive.labels
        # )

        naive.dat <- data.frame(
            X = as.numeric(naive_X_z > 0),
            y = naive.labels
        )

        m.naive <- glm(y ~ X, data = naive.dat, family = binomial())

        naive.coeff <- m.naive$coefficients["X"]
        naive.p <- summary(m.naive)$coef[2, 4] # pvalue

        out1 <- c(out1, naive.p)
        out2 <- c(out2, exp(naive.coeff))
        out3 <- c(out3, unlab.pos)

        # temp.out1 <- rcompanion::cohenW(naive.dat$y, naive.dat$X) # cohen_w


        # temp.out4 <- pwr.chisq.test(w = temp.out1, df = 1, N = 200, sig.level = 0.05)$power
        # out4 <- c(out4, temp.out4)

temp.out1<-cohens_d(naive_X_z ~ naive.dat$y)[[1]]


temp.out4<-pwr.2p2n.test(temp.out1,n.cases,n.naiv.control,0.05)[[5]]
out4 <- c(out4, temp.out4)

    } # loop

    return(list(
        n.cases = n.cases,
        n.naiv.control = n.naiv.control,
        prp.nondet = prp.nondet,
        eff.sz = eff.sz,
        naive.p = out1,
        naive.or = out2,
        unlabeled.pos = out3,
        naive.pwr = out4
    ))
}
```


this version samples from a binomial
```{r,include=FALSE}
sim.fun <- function(
    num.iter = NULL,
    n.cases = NULL,
    n.naiv.control = NULL,
    eff.sz = NULL,
    prp.nondet = NULL, ...) {
    out1 <- NULL
    out2 <- NULL
    out3 <- NULL
    out4 <- NULL

    ### numbers of things
    n.dogs <- n.cases + n.naiv.control # total number of dogs


    # control group is made up of the unlabeled pos and the real unaffected
    # number of positive dogs who are unlabled
    unlab.pos <- round(n.naiv.control * prp.nondet)
    n.tru.unaff <- n.naiv.control - unlab.pos # the number of unaffected

    n.tru.aff <- n.cases + unlab.pos # the number of positive dogs in both groups

    tru.labels <- c(rep(1, n.tru.aff), rep(0, (n.dogs - n.tru.aff)))
    naive.labels <- c(rep(1, n.cases), rep(0, n.naiv.control))



    for (i in 1:num.iter) {
        ### sample X
        # this is where the stocastic part comes in

        x.tru.affected <- rbinom(n.cases, 1, eff.sz + .2)

        x.tru.control <- c(
            rbinom(unlab.pos, 1, prob = eff.sz + .2),
            rbinom(n.tru.unaff, 1, prob = 0.2)
        )

        naive_X <- c(x.tru.affected, x.tru.control)
    

    
        naive.dat <- data.frame(
            X = naive_X,
            y = naive.labels
        )

         temp.out1 <- as.numeric(rcompanion::cohenW(naive.dat$y, naive.dat$X)) # cohen_w
        out1 <- c(out1, temp.out1)

         temp.out4 <- pwr.chisq.test(w = temp.out1, df = 1, N = 200, sig.level = 0.05)$power
         out4 <- c(out4, temp.out4)


    } # loop

    return(list(
        n.cases = n.cases,
        n.naiv.control = n.naiv.control,
        prp.nondet = prp.nondet,
        eff.sz = eff.sz,
        naive.pwr = out4,
        cohen = out1
    ))
}
```

```{r, echo=FALSE}
rcompanion::cohenW(c(rep(1,50),rep(0,100)), c(rep(1,60),rep(0,90)))

rstatix::chisq_test(c(rep(1,50),rep(0,100)), c(rep(1,60),rep(0,90)))

rcompanion::cohenW(c(rep(1,100),rep(0,50)), c(rep(1,105),rep(0,45)))
rstatix::chisq_test(c(rep(1,100),rep(0,50)), c(rep(1,105),rep(0,45)))


```

Run three at a time-makes all the data for the plot
```{r}
now <- Sys.time()


parmlist <- list(
    rep(5001, 3), # interations; num.iter
    rep(100, 3), # n.cases
    rep(100, 3), # number unlabeled
    rep(.1, 3), # eff.sz for normals
    seq(from = 0, to = 0.1, length.out = 3)
) # non-detection proportion

big.otpt_100_100 <- bind_rows(pmap(parmlist, sim.fun),
    .id = "column_label"
) # unlists and binds rows

smry.otpt_100_100 <- big.otpt_100_100 %>%
    group_by(n.cases, n.naiv.control, prp.nondet, eff.sz) %>%
    dplyr::summarise(
        prp.nondet = mean(prp.nondet),
        eff.sz = mean(eff.sz),
        naive.power = mean(naive.pwr),
        cohen = mean(cohen)
    )

pandoc.table(smry.otpt_100_100 %>% ungroup() %>% arrange(prp.nondet),
    style = "rmarkdown", digits = 3, split.table = Inf
)


parmlist <- list(
    rep(5001, 3), # interations; num.iter
    rep(150, 3), # n.cases
    rep(50, 3), # number unlabeled
    rep(.1, 3), # eff.sz for normals
    seq(from = 0, to = 0.1, length.out = 3)
) # non-detection proportion




big.otpt_150_50 <- bind_rows(pmap(parmlist, sim.fun),
    .id = "column_label"
) # unlists and binds rows

smry.otpt_150_50 <- big.otpt_150_50 %>%
    group_by(n.cases, n.naiv.control, prp.nondet, eff.sz) %>%
    dplyr::summarise(
        prp.nondet = mean(prp.nondet),
        eff.sz = mean(eff.sz),
        naive.power = mean(naive.pwr),
        cohen = mean(cohen)
    )


pandoc.table(smry.otpt_150_50 %>% ungroup() %>% arrange(prp.nondet),
    style = "rmarkdown", digits = 3, split.table = Inf
)


parmlist <- list(
    rep(5001, 3), # interations; num.iter
    rep(50, 3), # n.cases
    rep(150, 3), # number unlabeled
    rep(.1, 3), # eff.sz for normals
    seq(from = 0, to = 0.1, length.out = 3)
) # non-detection proportion



big.otpt_50_150 <- bind_rows(pmap(parmlist, sim.fun),
    .id = "column_label"
) # unlists and binds rows



smry.otpt_50_150 <- big.otpt_50_150 %>%
    group_by(n.cases, n.naiv.control, prp.nondet, eff.sz) %>%
    dplyr::summarise(
        prp.nondet = mean(prp.nondet),
        eff.sz = mean(eff.sz),
        naive.power = mean(naive.pwr),
        cohen = mean(cohen)
    )



pandoc.table(smry.otpt_50_150 %>% ungroup() %>% arrange(prp.nondet),
    style = "rmarkdown", digits = 3, split.table = Inf
)

difftime(Sys.time(), now)
```


usually use this one
The plot below is power loss normlize to the best power, which is 
balance groups (100,100) and 0 prp.nondet.
```{r, echo=FALSE}
df.plot1 <- smry.otpt_100_100 %>%
    ungroup() %>%
    select(n.cases, n.naiv.control, prp.nondet, naive.power) %>%
    reframe(prp.nondet = prp.nondet, zzz = naive.power /
        mean(naive.power[prp.nondet == 0])) %>%
    mutate(aaa = "1", prp.nondet = prp.nondet * 100, zzz = (zzz * 100) - 100)


mn_100_100 <- as.numeric(smry.otpt_100_100 %>%
    ungroup() %>%
    select(prp.nondet, naive.power) %>%
    reframe(mean(naive.power[prp.nondet == 0])))

df.plot2 <- smry.otpt_150_50 %>%
    ungroup() %>%
    select(n.cases, n.naiv.control, prp.nondet, naive.power) %>%
    reframe(prp.nondet = prp.nondet, zzz = naive.power / mn_100_100) %>%
    mutate(aaa = "2", prp.nondet = prp.nondet * 100, zzz = (zzz * 100) - 100)

df.plot3 <- smry.otpt_50_150 %>%
    ungroup() %>%
    select(n.cases, n.naiv.control, prp.nondet, naive.power) %>%
    reframe(prp.nondet = prp.nondet, zzz = naive.power / mn_100_100) %>%
    mutate(aaa = "3", prp.nondet = prp.nondet * 100, zzz = (zzz * 100) - 100)

df.plot <- bind_rows(df.plot1, df.plot2, df.plot3)

tiff("powerloss_all_three.tiff", units = "in", width = 7, height = 4, res = 600)

ggplot(data = df.plot, aes(x = prp.nondet, zzz, color = aaa)) +
    geom_smooth() +
    xlab("Percent undetected postitives in the control group") +
    ylab("Percent power loss") +
    labs(
        title = "Percent power loss from positive cases in the GWAS control group",
        subtitle = "Relative to max power: 100 cases, 100 controls with no undetected positives",
        caption = "Avg. observed effect size = 0.38, alpha = 0.05",
        color = "Naive sample sizes"
    ) +
    theme(
        plot.title = element_text(size = 14), # Center title position and size
        plot.subtitle = element_text(size = 10), # Center subtitle
        plot.caption = element_text(face = "italic") # move caption to the left
    ) +
    scale_color_discrete(labels = c("100 cases, 100 controls", "150 cases, 50 controls", "50 cases, 150 controls"))


dev.off()
```

# Sandbox

```{r,include=FALSE}


    n.cases <- 150
    n.naiv.control <- 50
    eff.sz <- 0.5
    prp.nondet <- 0

    ### numbers of things
    n.dogs <- n.cases + n.naiv.control # total number of dogs


    # control group is made up of the unlabeled pos and the real unaffected
    # number of positive dogs who are unlabled
    unlab.pos <- round(n.naiv.control * prp.nondet)
    n.tru.unaff <- n.naiv.control - unlab.pos # the number of unaffected

    n.tru.aff <- n.cases + unlab.pos # the number of positive dogs in both groups

    tru.labels <- c(rep(1, n.tru.aff), rep(0, (n.dogs - n.tru.aff)))
    naive.labels <- c(rep(1, n.cases), rep(0, n.naiv.control))

table(tru.labels)
table(naive.labels)


        ### sample X
        # this is where the stocastic part comes in

        x.tru.affected <- rnorm(n.cases, mean = eff.sz)

        x.tru.control <- c(
            rnorm(unlab.pos, mean = eff.sz),
            rnorm(n.tru.unaff)
        )

hist(x.tru.affected)
hist(x.tru.control)

        naive_X <- c(x.tru.affected, x.tru.control)
        naive_X_z <- (naive_X - mean(naive_X)) / sd(naive_X)

        # naive.dat <- data.frame(
        #     X = as.numeric(pnorm(naive_X_z) > runif(200, min = -.01, max = .01)),
        #     y = naive.labels
        # )

                naive.dat <- data.frame(
            X = as.numeric(naive_X_z > runif(200, min = -.01, max = .01)),
            y = naive.labels
        )
hist(naive_X_z)

temp.out1<-cohens_d(naive_X_z ~ naive.dat$y)[[1]]
#temp.out1<-rcompanion::cohenW(naive.dat$y, naive.dat$X) # cohen_w

temp.out1
#pwr.chisq.test(w = temp.out1, df = 1, N = 200, sig.level = 0.05)$power

pwr.2p2n.test(temp.out1,n.cases,n.naiv.control,0.05)[[5]]
```

