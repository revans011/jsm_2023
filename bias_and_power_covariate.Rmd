---
title: "sim"
author: Report by Rich Evans
date: 2023
output:
    html_document


---

This simulation implements part of:

Gu W, Swihart RK. Absent or undetected? Effects of non-detection of species occurrence on wildlifeâ€“habitat models. Biological conservation. 2004 Apr 1;116(2):195-203.

But they are random sampling a wildlife area. They randomly pick occupied areas in the simulation. In other words they have a grid and randomly assign the occupied areas. 

I have retrospective data there. I use a mixture of normals because I have sample sizes I need to investigate

```{r,include=FALSE}
#install.packages("pacman")
pacman::p_load(
       data.table, # to group and clean data
       tidyverse,  # allows use of pipe (%>%) function in this chapter
       janitor,     #for clean_names and tabyl
       broom,   #tidy output, use tidy(xxx)
       gtsummary,  #nice tables
       magrittr, # for %<>%
       effectsize,
       pROC,
       rstatix,
       pwr,   # power calculations
       pander, #to write tables as simple text for cut-and-paste
       knitr,
        kableExtra
   ) 
```




```{r,include=FALSE}

sim.fun<-function(num.iter = NULL
                  ,n.cases = NULL
                  ,n.naiv.control = NULL
                  ,eff.sz=NULL
                  ,prp.nondet = NULL,...){
out1 <- NULL
out2 <- NULL
out3 <- NULL
out4 <- NULL

n.dogs<-n.cases + n.naiv.control

unlab.pos <- round(n.naiv.control*prp.nondet)
n.tru.aff<-n.cases +unlab.pos

tru.labels<- c(rep(1,n.tru.aff),rep(0,(n.dogs-n.tru.aff)))
naive.labels<- c(rep(1,n.cases),rep(0,n.naiv.control))


for (i in 1:num.iter){


  
###sample X
# this is where the stocastic part comes in
  
x.tru.affected <- rnorm(n.tru.aff,mean=eff.sz)

x.tru.control<-c(rnorm(unlab.pos,mean=eff.sz),
                 rnorm(n.dogs-n.tru.aff-unlab.pos))
####NEED A MIXTURE FOR THE UNLABELED
# x.tru.affected <- runif(n.tru.aff,.5,1)
# x.tru.control<-c(runif(unlab.pos,.5,1),
#                  runif(n.dogs-n.tru.aff-unlab.pos,0,.5))
### estimate coeff naive model

naive.dat<-data.frame(X=c(x.tru.affected,x.tru.control),
                       y=naive.labels)

m.naive<-glm(y~X,data=naive.dat, family = binomial())

#naive.coeff<- m.naive$coefficients['X']
naive.coeff<- summary(m.naive)$coef[2,4]

#m.naive.pred <-predict(m.naive, type = "link")

out1<- c(out1,naive.coeff)
#out1 <- c(out1,as.numeric(roc(tru.labels ~ m.naive.pred)$auc))

out2<- c(out2,sum(tru.labels))
out3<- c(out3,sum(naive.labels))
 
} #loop

return(list(n.cases=n.cases,
            n.naiv.control=n.naiv.control,
                  prp.nondet=prp.nondet,
                  eff.sz=eff.sz,
                  naive.roc=out1,
                  ct.tru.pos=out2,
                  ct.naiv.pos=out3))
}


                    
```





```{r,results='asis'}


sim.table<-function(parmlist){
 
  now<-Sys.time()
  
foo<-pmap(parmlist,sim.fun)


goo <- bind_rows(foo, .id = "column_label")  #unlists and binds rows



zoo1 <- goo %>% group_by(n.cases,n.naiv.control,prp.nondet,eff.sz) %>% 
  dplyr::summarise(prp.nondet=mean(prp.nondet)
                   ,eff.sz=mean(eff.sz)
                   ,naive.roc.mn=mean(naive.roc)
                   ,naive.roc.sd=sd(naive.roc)
                   ,ct.tru.pos=mean(ct.tru.pos)
                   ,ct.naiv.pos=mean(ct.naiv.pos))

print(difftime(Sys.time(),now,units="mins"))
return(pandoc.table(zoo1 %>% ungroup() %>% arrange(desc(naive.roc.mn))
                    ,style='rmarkdown',digits=3,split.table=Inf))

}


oddsratio_to_d(2,log=FALSE) #this coverts OR to cohens so that I make this like SNPs data
d_to_oddsratio(.1)
oddsratio_to_d(1.2,log=FALSE)

 
```
<!-- https://cran.r-project.org/web/packages/pander/vignettes/pandoc_table.html -->

```{r, results='asis',message=FALSE,warning=FALSE}
###this checlks different patterns for the same sample size



# print("sample sizes from the papers: healey (216)")
#  parmlist<-list(
# c(rep(200,4)),             #interations; num.iter
# c(161,161,161,161),   #n.dogs
# c(55,55,55,55),   #n.dogs
# c(.01,.05,.1,.2) #non-detection proportion
# 
#  )
# 
# sim.table(parmlist=parmlist)


 print("sample sizes from the papers: healey (216)")
 parmlist<-list(
c(rep(5,2)),             #interations; num.iter
c(150,50),   #n.cases
c(50,150),   #number unlabeled
c(rep(.5,2)),  #eff.sz
c(rep(0.1,2)) #non-detection proportion

 )

sim.table(parmlist=parmlist)

```

